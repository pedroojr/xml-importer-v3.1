# ---------- Build (Vite) em Debian p/ evitar problemas do musl ----------
FROM node:20-bookworm-slim AS build
ENV NODE_ENV=production \
    npm_config_fund=false \
    npm_config_audit=false
WORKDIR /app

# Dependências de sistema leves para possíveis bindings (se houver)
RUN apt-get update -y \
 && apt-get install -y --no-install-recommends python3 make g++ ca-certificates curl git \
 && rm -rf /var/lib/apt/lists/*

COPY xml-importer-v3.1/package*.json ./
RUN npm ci --no-audit --no-fund

# Valor padrão; pode ser sobrescrito via build-arg
ARG VITE_API_BASE="https://api.xml.lojasrealce.shop"
ENV VITE_API_BASE=${VITE_API_BASE}

COPY xml-importer-v3.1/ .
# Build com logs; se falhar, mostra mais detalhes
RUN npm run build || npm run build --verbose

# ---------- Runtime (Nginx Alpine) ----------
FROM nginx:alpine
WORKDIR /
COPY --from=build /app/dist /usr/share/nginx/html
COPY xml-importer-v3.1/nginx.conf /etc/nginx/conf.d/default.conf
RUN apk add --no-cache curl
EXPOSE 80
HEALTHCHECK --interval=15s --timeout=5s --retries=5 CMD curl -fsS http://localhost || exit 1
